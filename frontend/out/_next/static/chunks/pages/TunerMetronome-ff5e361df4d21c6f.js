(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[600],{3186:(e,t,r)=>{"use strict";r.d(t,{x:()=>c});var n=r(4232),l=r(4590),s=r(900);let a=async()=>{try{console.log("Fetching audio devices..."),console.log("Platform:",s.Ii.getPlatform()),console.log("Backend URL:",l.Ic);try{let e=await fetch("".concat(l.Ic,"/audio-devices"));if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));let t=await e.json();if(console.log("Backend response:",t),!t.devices||0===t.devices.length)return{devices:[],error:"未检测到音频设备。请确保已连接麦克风或其他音频输入设备。"};return{devices:t.devices}}catch(e){return console.error("Web API error:",e),{devices:[],error:"无法连接到音频设备服务。请检查网络连接或重试。"}}}catch(e){return console.error("Error fetching audio devices:",e),e instanceof Error&&(console.error("Error details:",e.message),console.error("Error stack:",e.stack)),{devices:[],error:"获取音频设备时发生错误。请重试或联系支持。"}}},c=()=>{let[e,t]=(0,n.useState)([]),[r,l]=(0,n.useState)(0),[s,c]=(0,n.useState)(),[o,i]=(0,n.useState)(!0);(0,n.useEffect)(()=>{(async()=>{try{i(!0),c(void 0);let e=await a();e.error?(c(e.error),t([])):(t(e.devices),e.devices.length>0&&l(e.devices[0].index))}catch(e){c("加载音频设备时发生错误"),t([])}finally{i(!1)}})()},[]);let u=async()=>{let e=await a();e.error?(c(e.error),t([])):(t(e.devices),e.devices.length>0&&l(e.devices[0].index))};return{audioDevices:e,selectedAudioDevice:r,setSelectedAudioDevice:l,error:s,isLoading:o,refreshDevices:u}}},3660:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/TunerMetronome",function(){return r(7966)}])},4590:(e,t,r)=>{"use strict";r.d(t,{Ic:()=>i,WW:()=>o,pt:()=>c,w8:()=>a,y4:()=>l}),r(900);var n=r(5364);let l=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";try{let r=atob(e),n=r.length,l=new Uint8Array(n);for(let e=0;e<n;e++)l[e]=r.charCodeAt(e);return new Blob([l],{type:t})}catch(e){return console.error("Failed to decode Base64 data:",e),null}},s=()=>(n.env.NEXT_CLOUD_BACKEND_URL,"http://192.168.68.58:8101/cloud"),a=(e,t)=>"score"===t?"".concat(s(),"/get-score-file-by-id/").concat(e):"audio"===t?"".concat(s(),"/get-audio-file-by-id/").concat(e):"midi"===t?"".concat(s(),"/get-midi-file-by-id/").concat(e):"";var c=function(e){return e.SCORE="score",e.AUDIO="audio",e.MIDI="midi",e}({});let o=s(),i=(n.env.NEXT_LOCAL_BACKEND_URL||"http://localhost:8201")+"/local"},5895:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});var n=r(7876);r(4232);let l=e=>{let{audioDevices:t,selectedAudioDevice:r,setSelectedAudioDevice:l,error:s,isLoading:a,onRefresh:c}=e;return a?(0,n.jsx)("div",{className:"w-full text-center py-2 text-gray-600",children:"正在加载音频设备..."}):s?(0,n.jsxs)("div",{className:"w-full",children:[(0,n.jsx)("div",{className:"text-red-500 mb-2",children:s}),c&&(0,n.jsx)("button",{onClick:c,className:"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors",children:"重试"})]}):0===t.length?(0,n.jsx)("div",{className:"w-full text-center py-2 text-gray-600",children:"未检测到音频设备"}):(0,n.jsx)("div",{children:(0,n.jsx)("select",{value:r,onChange:e=>l(Number(e.target.value)),className:"w-full px-4 py-2 rounded-md bg-white border border-gray-200 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all duration-200",children:t.map((e,t)=>(0,n.jsx)("option",{value:e.index,children:e.name||"音频设备 ".concat(t+1)},t))})})}},7966:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>x});var n=r(7876),l=r(4232),s=r(9099),a=r(3186),c=r(4590);let o=[{string:"G",frequency:196,note:"G3"},{string:"D",frequency:293.66,note:"D4"},{string:"A",frequency:440,note:"A4"},{string:"E",frequency:659.25,note:"E5"}],i=e=>{let{selectedAudioDevice:t}=e,[r,s]=(0,l.useState)(null),[a,i]=(0,l.useState)("G"),[u,d]=(0,l.useState)(null),[x,h]=(0,l.useState)(null),[g,m]=(0,l.useState)(!1),[f,b]=(0,l.useState)(0),[v,y]=(0,l.useState)(!1),j=(0,l.useRef)(null),p=(0,l.useRef)(0),N=(0,l.useRef)(null);(0,l.useEffect)(()=>(w(),()=>{j.current&&j.current.readyState===WebSocket.OPEN&&(j.current.send(JSON.stringify({action:"stop"})),j.current.close()),N.current&&clearTimeout(N.current)}),[]);let w=()=>{j.current&&j.current.close();let e=new WebSocket(c.Ic.replace(/^http/,"ws")+"/ws/tuner/violin");j.current=e,e.onopen=()=>{console.log("Violin tuner WebSocket connected"),e.send(JSON.stringify({device_index:t}))},e.onmessage=e=>{try{let r=JSON.parse(e.data),n=Date.now();if(n-p.current<30)return;if(p.current=n,r.no_sound){s(null),b(0),d(null),h(null);return}if(r.frequency){var t;m(!0),s(r.frequency),b(r.volume||0);let e=null==(t=o.find(e=>e.string===a))?void 0:t.frequency,n=r.frequency-e;d(n),h(1>Math.abs(n)),y(!1),N.current&&clearTimeout(N.current)}}catch(e){console.error("Error parsing WebSocket message:",e)}},e.onerror=e=>{console.error("WebSocket error:",e)},e.onclose=()=>{console.log("WebSocket closed")}};(0,l.useEffect)(()=>{g&&!v&&(N.current&&clearTimeout(N.current),N.current=setTimeout(()=>{y(!0)},2e3))},[g,r]);let S=()=>null===u?"text-gray-500":1>Math.abs(u)?"text-green-500":5>Math.abs(u)?"text-yellow-500":"text-red-500";return(0,n.jsxs)("div",{className:"p-4 max-w-md mx-auto",children:[(0,n.jsx)("div",{className:"mb-8",children:(0,n.jsx)("div",{className:"relative h-48",children:(0,n.jsx)("div",{className:"absolute inset-0 flex flex-col justify-between",children:o.map(e=>(0,n.jsxs)("div",{className:"flex items-center justify-between h-12 px-4 rounded-lg transition-all duration-200 ".concat(a===e.string?"bg-blue-100":"bg-gray-100"),onClick:()=>i(e.string),children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("div",{className:"w-2 h-8 bg-gray-800 rounded-full mr-4"}),(0,n.jsxs)("span",{className:"text-lg font-bold",children:[e.string,"弦"]})]}),(0,n.jsxs)("div",{className:"text-sm text-gray-600",children:[e.note," (",e.frequency," Hz)"]})]},e.string))})})}),(0,n.jsxs)("div",{className:"text-center space-y-4",children:[!g&&(0,n.jsx)("div",{className:"text-yellow-600 bg-yellow-100 p-4 rounded-lg",children:"未检测到音频输入，请确保麦克风已连接并允许访问"}),v&&(0,n.jsx)("div",{className:"text-blue-600 bg-blue-100 p-4 rounded-lg",children:"好像没有声音哦~"}),(0,n.jsx)("div",{className:"text-2xl font-bold",children:r?"".concat(r.toFixed(2)," Hz"):"-- Hz"}),(0,n.jsx)("div",{className:"h-4 bg-gray-200 rounded-full overflow-hidden",children:(0,n.jsx)("div",{className:"h-full bg-blue-500 transition-all duration-100",style:{width:"".concat(Math.min(100*f,100),"%")}})}),(0,n.jsxs)("div",{className:"relative h-16 bg-gray-100 rounded-lg overflow-hidden",children:[(0,n.jsx)("div",{className:"absolute top-0 h-full w-1 bg-current ".concat(S()),style:{left:"".concat(50+(u?Math.min(Math.max(10*u,-50),50):0),"%"),transition:"left 0.1s ease-out"}}),(0,n.jsx)("div",{className:"absolute top-0 left-1/2 h-full w-1 bg-green-500"})]}),(0,n.jsx)("div",{className:"text-3xl font-bold ".concat(S()),children:null!==u?"".concat(null===u?"":1>Math.abs(u)?"✓":u>0?"↑":"↓"," ").concat(Math.abs(u).toFixed(2)," Hz"):"-- Hz"}),(0,n.jsxs)("div",{className:"text-lg",children:[!0===x&&"音准正确 ✓",!1===x&&"请调整琴弦",null===x&&"等待检测..."]})]})]})},u=()=>{let[e,t]=(0,l.useState)(100),[r,s]=(0,l.useState)(!1),[a,c]=(0,l.useState)(0),o=(0,l.useRef)(null),i=(0,l.useRef)(null),u=(0,l.useRef)(null);return(0,l.useEffect)(()=>(r?o.current=setInterval(()=>{c(e=>(e+1)%4),i.current&&(i.current.currentTime=0,i.current.play().catch(e=>{console.error("Error playing audio:",e)}))},60/e*1e3):o.current&&clearInterval(o.current),()=>{o.current&&clearInterval(o.current)}),[r,e]),(0,n.jsxs)("div",{className:"p-4",children:[(0,n.jsxs)("div",{className:"flex justify-center items-center space-x-4 mt-4",children:[(0,n.jsx)("button",{onClick:()=>s(!r),className:"bg-blue-500 text-white px-4 py-2 rounded",children:r?"暂停":"播放"}),(0,n.jsx)("input",{type:"range",min:"30",max:"320",value:e,onChange:e=>{t(Number(e.target.value))},className:"w-64 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer transition-all duration-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500",style:{background:"linear-gradient(to right, #007bff ".concat((e-30)/290*100,"%, #e0e0e0 ").concat((e-30)/290*100,"%)")},ref:u}),(0,n.jsx)("input",{type:"number",value:e,onChange:e=>t(Number(e.target.value)),className:"w-16 text-center border border-gray-300 rounded"}),(0,n.jsx)("span",{children:"BPM"})]}),(0,n.jsx)("div",{className:"flex justify-center mt-4",children:[0,1,2,3].map(e=>(0,n.jsx)("div",{className:"w-4 h-4 mx-1 rounded-full ".concat(a===e?"bg-blue-500":"bg-gray-300")},e))}),(0,n.jsx)("audio",{ref:i,src:"/click-sound.mp3",preload:"auto"})]})};var d=r(5895);let x=()=>{let e=(0,s.useRouter)(),{tab:t}=e.query,{audioDevices:r,selectedAudioDevice:c,setSelectedAudioDevice:o,error:x,isLoading:h,refreshDevices:g}=(0,a.x)(),[m,f]=(0,l.useState)(null),[b,v]=(0,l.useState)("Violin");return(0,l.useEffect)(()=>{"Metronome"===t?f("Metronome"):f("Tuner")},[t]),(0,n.jsxs)("div",{className:"min-h-screen flex flex-col",children:[(0,n.jsxs)("header",{className:"flex justify-between items-center p-4 bg-gray-800 text-white",children:[(0,n.jsx)("h1",{className:"text-xl font-bold",children:"调音器 & 节拍器"}),(0,n.jsx)("button",{onClick:()=>e.back(),className:"bg-red-500 text-white px-4 py-2 rounded",children:"返回"})]}),(0,n.jsxs)("div",{className:"flex justify-center space-x-4 mt-4",children:[(0,n.jsx)("button",{onClick:()=>f("Tuner"),className:"px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat("Tuner"===m?"bg-blue-500 text-white shadow-md scale-105":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:"\uD83C\uDFB5 调音器"}),(0,n.jsx)("button",{onClick:()=>f("Metronome"),className:"px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat("Metronome"===m?"bg-blue-500 text-white shadow-md scale-105":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:"⏱️ 节拍器"})]}),"Tuner"===m&&(0,n.jsxs)("div",{className:"p-4",children:[(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("label",{className:"block text-gray-700",children:"选择音源设备:"}),(0,n.jsx)(d.A,{audioDevices:r,selectedAudioDevice:c,setSelectedAudioDevice:o,error:x,isLoading:h,onRefresh:g})]}),(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("label",{className:"block text-gray-700",children:"选择乐器:"}),(0,n.jsxs)("select",{value:b,onChange:e=>v(e.target.value),className:"w-full px-4 py-2 rounded-md bg-white border border-gray-200 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all duration-200",children:[(0,n.jsx)("option",{value:"Violin",children:"\uD83C\uDFBB 小提琴"}),(0,n.jsx)("option",{value:"Viola",children:"\uD83C\uDFBB 中提琴"}),(0,n.jsx)("option",{value:"Cello",children:"\uD83C\uDFBB 大提琴"}),(0,n.jsx)("option",{value:"Guitar",children:"\uD83C\uDFB8 吉他"}),(0,n.jsx)("option",{value:"Ukulele",children:"\uD83C\uDFB8 尤克里里"})]})]}),(0,n.jsx)("div",{className:"mt-4",children:"Violin"===b?x||h?null:(0,n.jsx)(i,{selectedAudioDevice:c}):(0,n.jsx)("p",{className:"text-center text-gray-600",children:"该乐器的调音器尚未开发。"})})]}),"Metronome"===m&&(0,n.jsx)(u,{})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[918,636,593,792],()=>t(3660)),_N_E=e.O()}]);