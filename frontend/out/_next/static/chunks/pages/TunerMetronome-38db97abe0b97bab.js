(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[600],{1816:(e,t,r)=>{"use strict";r.d(t,{x:()=>o});var n=r(4232),l=r(4590),a=r(900);let s=(0,a.F3)("AudioDevice"),c=async()=>{try{if("android"===a.Ii.getPlatform()){let{devices:e}=await s.getAudioInputDevices();return e.map((e,t)=>({index:t,name:e.name||"Audio Device ".concat(t+1)}))}{let e=await fetch("".concat(l.Ic,"/audio-devices"));return(await e.json()).devices||[]}}catch(e){return console.error("Error fetching audio devices:",e),[]}},o=()=>{let[e,t]=(0,n.useState)([]),[r,l]=(0,n.useState)(0);return(0,n.useEffect)(()=>{(async()=>{let e=await c();t(e),e.length>0&&l(e[0].index)})()},[]),{audioDevices:e,selectedAudioDevice:r,setSelectedAudioDevice:l}}},3660:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/TunerMetronome",function(){return r(7966)}])},4590:(e,t,r)=>{"use strict";r.d(t,{Ic:()=>u,WW:()=>i,pt:()=>o,w8:()=>c,y4:()=>a});var n=r(900),l=r(5364);let a=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";try{let r=atob(e),n=r.length,l=new Uint8Array(n);for(let e=0;e<n;e++)l[e]=r.charCodeAt(e);return new Blob([l],{type:t})}catch(e){return console.error("Failed to decode Base64 data:",e),null}},s=()=>("android"===n.Ii.getPlatform()||l.env.NEXT_CLOUD_BACKEND_URL,"http://192.168.68.58:8101/cloud"),c=(e,t)=>"score"===t?"".concat(s(),"/get-score-file-by-id/").concat(e):"audio"===t?"".concat(s(),"/get-audio-file-by-id/").concat(e):"midi"===t?"".concat(s(),"/get-midi-file-by-id/").concat(e):"";var o=function(e){return e.SCORE="score",e.AUDIO="audio",e.MIDI="midi",e}({});let i=s(),u=("android"===n.Ii.getPlatform()?"http://10.0.2.2:8201":l.env.NEXT_LOCAL_BACKEND_URL||"http://localhost:8201")+"/local"},5895:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});var n=r(7876);r(4232);let l=e=>{let{audioDevices:t,selectedAudioDevice:r,setSelectedAudioDevice:l}=e;return(0,n.jsx)("div",{children:(0,n.jsx)("select",{value:r,onChange:e=>l(Number(e.target.value)),className:"w-full px-4 py-2 rounded-md bg-white border border-gray-200 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all duration-200",children:t.map((e,t)=>(0,n.jsx)("option",{value:e.index,children:e.name||"Audio Device ".concat(t+1)},t))})})}},7966:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>x});var n=r(7876),l=r(4232),a=r(9099),s=r(1816),c=r(4590);let o=[{string:"G",frequency:196,note:"G3"},{string:"D",frequency:293.66,note:"D4"},{string:"A",frequency:440,note:"A4"},{string:"E",frequency:659.25,note:"E5"}],i=e=>{let{selectedAudioDevice:t}=e,[r,a]=(0,l.useState)(null),[s,i]=(0,l.useState)("G"),[u,d]=(0,l.useState)(null),[x,m]=(0,l.useState)(null),[h,g]=(0,l.useState)(!1),[f,b]=(0,l.useState)(0),[v,y]=(0,l.useState)(!1),p=(0,l.useRef)(null),j=(0,l.useRef)(0),N=(0,l.useRef)(null);(0,l.useEffect)(()=>(w(),()=>{p.current&&p.current.readyState===WebSocket.OPEN&&(p.current.send(JSON.stringify({action:"stop"})),p.current.close()),N.current&&clearTimeout(N.current)}),[]);let w=()=>{p.current&&p.current.close();let e=new WebSocket(c.Ic.replace(/^http/,"ws")+"/ws/tuner/violin");p.current=e,e.onopen=()=>{console.log("Violin tuner WebSocket connected"),e.send(JSON.stringify({device_index:t}))},e.onmessage=e=>{try{let r=JSON.parse(e.data),n=Date.now();if(n-j.current<30)return;if(j.current=n,r.no_sound){a(null),b(0),d(null),m(null);return}if(r.frequency){var t;g(!0),a(r.frequency),b(r.volume||0);let e=null==(t=o.find(e=>e.string===s))?void 0:t.frequency,n=r.frequency-e;d(n),m(1>Math.abs(n)),y(!1),N.current&&clearTimeout(N.current)}}catch(e){console.error("Error parsing WebSocket message:",e)}},e.onerror=e=>{console.error("WebSocket error:",e)},e.onclose=()=>{console.log("WebSocket closed")}};(0,l.useEffect)(()=>{h&&!v&&(N.current&&clearTimeout(N.current),N.current=setTimeout(()=>{y(!0)},2e3))},[h,r]);let D=()=>null===u?"text-gray-500":1>Math.abs(u)?"text-green-500":5>Math.abs(u)?"text-yellow-500":"text-red-500";return(0,n.jsxs)("div",{className:"p-4 max-w-md mx-auto",children:[(0,n.jsx)("div",{className:"mb-8",children:(0,n.jsx)("div",{className:"relative h-48",children:(0,n.jsx)("div",{className:"absolute inset-0 flex flex-col justify-between",children:o.map(e=>(0,n.jsxs)("div",{className:"flex items-center justify-between h-12 px-4 rounded-lg transition-all duration-200 ".concat(s===e.string?"bg-blue-100":"bg-gray-100"),onClick:()=>i(e.string),children:[(0,n.jsxs)("div",{className:"flex items-center",children:[(0,n.jsx)("div",{className:"w-2 h-8 bg-gray-800 rounded-full mr-4"}),(0,n.jsxs)("span",{className:"text-lg font-bold",children:[e.string,"弦"]})]}),(0,n.jsxs)("div",{className:"text-sm text-gray-600",children:[e.note," (",e.frequency," Hz)"]})]},e.string))})})}),(0,n.jsxs)("div",{className:"text-center space-y-4",children:[!h&&(0,n.jsx)("div",{className:"text-yellow-600 bg-yellow-100 p-4 rounded-lg",children:"未检测到音频输入，请确保麦克风已连接并允许访问"}),v&&(0,n.jsx)("div",{className:"text-blue-600 bg-blue-100 p-4 rounded-lg",children:"好像没有声音哦~"}),(0,n.jsx)("div",{className:"text-2xl font-bold",children:r?"".concat(r.toFixed(2)," Hz"):"-- Hz"}),(0,n.jsx)("div",{className:"h-4 bg-gray-200 rounded-full overflow-hidden",children:(0,n.jsx)("div",{className:"h-full bg-blue-500 transition-all duration-100",style:{width:"".concat(Math.min(100*f,100),"%")}})}),(0,n.jsxs)("div",{className:"relative h-16 bg-gray-100 rounded-lg overflow-hidden",children:[(0,n.jsx)("div",{className:"absolute top-0 h-full w-1 bg-current ".concat(D()),style:{left:"".concat(50+(u?Math.min(Math.max(10*u,-50),50):0),"%"),transition:"left 0.1s ease-out"}}),(0,n.jsx)("div",{className:"absolute top-0 left-1/2 h-full w-1 bg-green-500"})]}),(0,n.jsx)("div",{className:"text-3xl font-bold ".concat(D()),children:null!==u?"".concat(null===u?"":1>Math.abs(u)?"✓":u>0?"↑":"↓"," ").concat(Math.abs(u).toFixed(2)," Hz"):"-- Hz"}),(0,n.jsxs)("div",{className:"text-lg",children:[!0===x&&"音准正确 ✓",!1===x&&"请调整琴弦",null===x&&"等待检测..."]})]})]})},u=()=>{let[e,t]=(0,l.useState)(100),[r,a]=(0,l.useState)(!1),[s,c]=(0,l.useState)(0),o=(0,l.useRef)(null),i=(0,l.useRef)(null),u=(0,l.useRef)(null);return(0,l.useEffect)(()=>(r?o.current=setInterval(()=>{c(e=>(e+1)%4),i.current&&(i.current.currentTime=0,i.current.play().catch(e=>{console.error("Error playing audio:",e)}))},60/e*1e3):o.current&&clearInterval(o.current),()=>{o.current&&clearInterval(o.current)}),[r,e]),(0,n.jsxs)("div",{className:"p-4",children:[(0,n.jsxs)("div",{className:"flex justify-center items-center space-x-4 mt-4",children:[(0,n.jsx)("button",{onClick:()=>a(!r),className:"bg-blue-500 text-white px-4 py-2 rounded",children:r?"暂停":"播放"}),(0,n.jsx)("input",{type:"range",min:"30",max:"320",value:e,onChange:e=>{t(Number(e.target.value))},className:"w-64 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer transition-all duration-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500",style:{background:"linear-gradient(to right, #007bff ".concat((e-30)/290*100,"%, #e0e0e0 ").concat((e-30)/290*100,"%)")},ref:u}),(0,n.jsx)("input",{type:"number",value:e,onChange:e=>t(Number(e.target.value)),className:"w-16 text-center border border-gray-300 rounded"}),(0,n.jsx)("span",{children:"BPM"})]}),(0,n.jsx)("div",{className:"flex justify-center mt-4",children:[0,1,2,3].map(e=>(0,n.jsx)("div",{className:"w-4 h-4 mx-1 rounded-full ".concat(s===e?"bg-blue-500":"bg-gray-300")},e))}),(0,n.jsx)("audio",{ref:i,src:"/click-sound.mp3",preload:"auto"})]})};var d=r(5895);let x=()=>{let e=(0,a.useRouter)(),{tab:t}=e.query,{audioDevices:r,selectedAudioDevice:c,setSelectedAudioDevice:o}=(0,s.x)(),[x,m]=(0,l.useState)(null),[h,g]=(0,l.useState)("Violin");return(0,l.useEffect)(()=>{"Metronome"===t?m("Metronome"):m("Tuner")},[t]),(0,n.jsxs)("div",{className:"min-h-screen flex flex-col",children:[(0,n.jsxs)("header",{className:"flex justify-between items-center p-4 bg-gray-800 text-white",children:[(0,n.jsx)("h1",{className:"text-xl font-bold",children:"调音器 & 节拍器"}),(0,n.jsx)("button",{onClick:()=>e.back(),className:"bg-red-500 text-white px-4 py-2 rounded",children:"返回"})]}),(0,n.jsxs)("div",{className:"flex justify-center space-x-4 mt-4",children:[(0,n.jsx)("button",{onClick:()=>m("Tuner"),className:"px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat("Tuner"===x?"bg-blue-500 text-white shadow-md scale-105":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:"\uD83C\uDFB5 调音器"}),(0,n.jsx)("button",{onClick:()=>m("Metronome"),className:"px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat("Metronome"===x?"bg-blue-500 text-white shadow-md scale-105":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:"⏱️ 节拍器"})]}),"Tuner"===x&&(0,n.jsxs)("div",{className:"p-4",children:[(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("label",{className:"block text-gray-700",children:"选择音源设备:"}),(0,n.jsx)(d.A,{audioDevices:r,selectedAudioDevice:c,setSelectedAudioDevice:o})]}),(0,n.jsxs)("div",{className:"mt-4",children:[(0,n.jsx)("label",{className:"block text-gray-700",children:"选择乐器:"}),(0,n.jsxs)("select",{value:h,onChange:e=>g(e.target.value),className:"w-full px-4 py-2 rounded-md bg-white border border-gray-200 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all duration-200",children:[(0,n.jsx)("option",{value:"Violin",children:"\uD83C\uDFBB 小提琴"}),(0,n.jsx)("option",{value:"Viola",children:"\uD83C\uDFBB 中提琴"}),(0,n.jsx)("option",{value:"Cello",children:"\uD83C\uDFBB 大提琴"}),(0,n.jsx)("option",{value:"Guitar",children:"\uD83C\uDFB8 吉他"}),(0,n.jsx)("option",{value:"Ukulele",children:"\uD83C\uDFB8 尤克里里"})]})]}),(0,n.jsx)("div",{className:"mt-4",children:"Violin"===h?(0,n.jsx)(i,{selectedAudioDevice:c}):(0,n.jsx)("p",{className:"text-center text-gray-600",children:"该乐器的调音器尚未开发。"})})]}),"Metronome"===x&&(0,n.jsx)(u,{})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[918,636,593,792],()=>t(3660)),_N_E=e.O()}]);