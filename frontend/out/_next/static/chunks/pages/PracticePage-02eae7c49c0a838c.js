(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6],{1816:(e,t,r)=>{"use strict";r.d(t,{x:()=>i});var n=r(4232),o=r(4590),l=r(900);let c=(0,l.F3)("AudioDevice"),a=async()=>{try{if("android"===l.Ii.getPlatform()){let{devices:e}=await c.getAudioInputDevices();return e.map((e,t)=>({index:t,name:e.name||"Audio Device ".concat(t+1)}))}{let e=await fetch("".concat(o.Ic,"/audio-devices"));return(await e.json()).devices||[]}}catch(e){return console.error("Error fetching audio devices:",e),[]}},i=()=>{let[e,t]=(0,n.useState)([]),[r,o]=(0,n.useState)(0);return(0,n.useEffect)(()=>{(async()=>{let e=await a();t(e),e.length>0&&o(e[0].index)})()},[]),{audioDevices:e,selectedAudioDevice:r,setSelectedAudioDevice:o}}},4287:(e,t,r)=>{"use strict";r.d(t,{X:()=>n});let n=(0,r(5664).eU)({key:"practiceState",default:null})},4340:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/PracticePage",function(){return r(8990)}])},4590:(e,t,r)=>{"use strict";r.d(t,{Ic:()=>u,WW:()=>s,pt:()=>i,w8:()=>a,y4:()=>l});var n=r(900),o=r(5364);let l=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";try{let r=atob(e),n=r.length,o=new Uint8Array(n);for(let e=0;e<n;e++)o[e]=r.charCodeAt(e);return new Blob([o],{type:t})}catch(e){return console.error("Failed to decode Base64 data:",e),null}},c=()=>("android"===n.Ii.getPlatform()||o.env.NEXT_CLOUD_BACKEND_URL,"http://192.168.68.58:8101/cloud"),a=(e,t)=>"score"===t?"".concat(c(),"/get-score-file-by-id/").concat(e):"audio"===t?"".concat(c(),"/get-audio-file-by-id/").concat(e):"midi"===t?"".concat(c(),"/get-midi-file-by-id/").concat(e):"";var i=function(e){return e.SCORE="score",e.AUDIO="audio",e.MIDI="midi",e}({});let s=c(),u=("android"===n.Ii.getPlatform()?"http://10.0.2.2:8201":o.env.NEXT_LOCAL_BACKEND_URL||"http://localhost:8201")+"/local"},5895:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var n=r(7876);r(4232);let o=e=>{let{audioDevices:t,selectedAudioDevice:r,setSelectedAudioDevice:o}=e;return(0,n.jsx)("div",{children:(0,n.jsx)("select",{value:r,onChange:e=>o(Number(e.target.value)),className:"w-full px-4 py-2 rounded-md bg-white border border-gray-200 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all duration-200",children:t.map((e,t)=>(0,n.jsx)("option",{value:e.index,children:e.name||"Audio Device ".concat(t+1)},t))})})}},8990:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>b});var n=r(7876),o=r(4232),l=r(9099),c=r(885);r(379);let a=(0,o.forwardRef)((e,t)=>{let{isPerformceModel:r,audioUrl:l,isPlaying:a,onPlay:i,onPause:s,onEnded:u}=e,d=o.useRef(null);return(0,o.useImperativeHandle)(t,()=>({play:()=>{var e;null==(e=d.current)||e.audio.current.play()},pause:()=>{var e;null==(e=d.current)||e.audio.current.pause()},seekTo:e=>{var t;(null==(t=d.current)?void 0:t.audio.current)&&(d.current.audio.current.currentTime=e)},getCurrentTime:()=>{var e,t;return(null==(t=d.current)||null==(e=t.audio.current)?void 0:e.currentTime)||0}})),o.useEffect(()=>()=>{l&&URL.revokeObjectURL(l)},[r,l]),(0,n.jsx)("div",{children:(0,n.jsx)(c.A,{ref:d,src:l,showSkipControls:!1,showJumpControls:!1,showDownloadProgress:!1,autoPlay:a,onPlay:i,onPause:s,onEnded:u})})}),i=e=>{let{deviceIndex:t}=e,r=(0,o.useRef)(null),l=(0,o.useRef)(),c=(0,o.useRef)(null),a=(0,o.useRef)(null),i=(0,o.useRef)(null);(0,o.useEffect)(()=>{(async()=>{try{let e=new(window.AudioContext||window.webkitAudioContext);c.current=e;let r=await navigator.mediaDevices.getUserMedia({audio:{deviceId:t.toString(),echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),n=e.createAnalyser();n.fftSize=256,a.current=n;let o=e.createMediaStreamSource(r);return i.current=o,o.connect(n),s(),()=>{i.current&&i.current.disconnect(),c.current&&c.current.close(),l.current&&cancelAnimationFrame(l.current)}}catch(e){console.error("Error setting up audio:",e)}})()},[t]);let s=()=>{let e,t=r.current,n=a.current;if(!t||!n)return;let o=t.getContext("2d");if(!o)return;let c=n.frequencyBinCount,i=new Uint8Array(c);n.getByteFrequencyData(i),o.fillStyle="rgb(240, 240, 240)",o.fillRect(0,0,t.width,t.height);let u=t.width/c*2,d=0;for(let r=0;r<c;r++){e=i[r]/255*t.height;let n=o.createLinearGradient(0,0,0,t.height);n.addColorStop(0,"#4ade80"),n.addColorStop(.5,"#fbbf24"),n.addColorStop(1,"#ef4444"),o.fillStyle=n,o.beginPath(),o.moveTo(d+2,t.height),o.lineTo(d+u-2,t.height),o.quadraticCurveTo(d+u,t.height,d+u,t.height-2),o.lineTo(d+u,t.height-e+2),o.quadraticCurveTo(d+u,t.height-e,d+u-2,t.height-e),o.lineTo(d+2,t.height-e),o.quadraticCurveTo(d,t.height-e,d,t.height-e+2),o.lineTo(d,t.height-2),o.quadraticCurveTo(d,t.height,d+2,t.height),o.closePath(),o.fill(),d+=u+1}l.current=requestAnimationFrame(s)};return(0,n.jsx)("div",{className:"flex items-center space-x-4",children:(0,n.jsx)("div",{className:"h-10 w-48 bg-white border border-gray-200 rounded-md shadow-sm overflow-hidden",children:(0,n.jsx)("canvas",{ref:r,width:192,height:40,className:"w-full h-full"})})})};var s=r(5602),u=r(4590),d=r(5664),h=r(4287),f=r(1816),g=r(9190),m=r(5895);let x="MIDI",p="Audio",b=()=>{let e=(0,l.useRouter)(),t=(0,d.vc)(h.X),{audioDevices:r,selectedAudioDevice:c,setSelectedAudioDevice:b}=(0,f.x)(),w=(0,o.useRef)(null),v=(0,o.useRef)(null),y=(0,o.useRef)(null),C=(0,o.useRef)(null),j=(0,o.useRef)(null),S=(0,o.useRef)({}),N=(0,o.useRef)(null),I=(0,o.useRef)([]),[R,k]=(0,o.useState)(!1),[E,T]=(0,o.useState)(x),[D,A]=(0,o.useState)([]),[P,_]=(0,o.useState)(""),[U,O]=(0,o.useState)(0),[W,M]=(0,o.useState)(0),[L,B]=(0,o.useState)(0),[F,q]=(0,o.useState)(!1),[V,X]=(0,o.useState)(null),[z,J]=(0,o.useState)("follow"),[G,H]=(0,o.useState)(!1),K=(0,o.useMemo)(()=>{if(t){if("true"===t.useUrl)return t.audioUrl;if(t.audioContent){let e="string"==typeof t.audioContent?(0,u.y4)(t.audioContent):null;return e?URL.createObjectURL(e):void 0}}},[F]);(0,o.useEffect)(()=>{console.log("Real-time position: ".concat(W,", Anchor position index: ").concat(U)),W!==U&&(Q(W),console.log("realTimePosition: ",W),O(W),console.log("Best position updated to:",U))},[W]),(0,o.useEffect)(()=>{w.current&&t&&(j.current=t.fileInfo.id,v.current=new s.OpenSheetMusicDisplay(w.current),console.log("OSMD initialized"),(async()=>{try{if("false"===t.useUrl&&t.fileContent){let e=(0,u.y4)(t.fileContent);if(null===e)return;let r=await e.text();await v.current.load(r),await v.current.render(),y.current=v.current.cursor,console.log("Cursor initialized:",y.current),ee(v.current),y.current&&(y.current.reset(),y.current.show(),console.log("Cursor position after reset:",y.current.Iterator.currentTimeStamp.RealValue))}else if("true"===t.useUrl&&t.fileUrl){let e=await fetch((0,u.w8)(t.fileInfo.id,u.pt.SCORE));if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));let r=await e.text();await v.current.load(r),await v.current.render(),y.current=v.current.cursor,console.log("Cursor initialized:",y.current),ee(v.current),y.current&&(y.current.reset(),y.current.show(),console.log("Cursor position after reset:",y.current.Iterator.currentTimeStamp.RealValue))}}catch(e){console.error("Error loading file:",e)}})())},[t]),(0,o.useEffect)(()=>{E===p?r.length>0&&b(r[0].index):E===x&&et()},[E]);let Q=e=>{if(Z("Moving to target beat: ".concat(e)),v.current&&(y.current=v.current.cursor,y.current)){let t=Y(),r=S.current[t],n=S.current[e];if(void 0===r)return void Z("Invalid current beat position. Cursor's current beat: ".concat(t));if(void 0===n){let t=Object.keys(S.current).map(Number).sort((e,t)=>e-t),r=$(t,e);n=S.current[t[r]],Z("Closest target index found: ".concat(n))}let o=n-r;if(Z("Steps to move: ".concat(o)),o>0)for(let e=0;e<o;e++)y.current.next();else if(o<0)for(let e=0;e<Math.abs(o);e++)y.current.previous();v.current.cursor.update(),y.current.show()}},Y=()=>y.current&&y.current.Iterator?4*y.current.Iterator.currentTimeStamp.RealValue:0,Z=e=>{let t=new Date().toISOString();console.log("[".concat(t,"] ").concat(e))},$=(e,t)=>{let r=e.findLastIndex(e=>e<=t);return -1===r&&(r=0),r},ee=e=>{if(e&&e.cursor){let o=e.cursor.Iterator;for(var t=[];!o.EndReached;){let e=o.CurrentVoiceEntries;for(var r=0;r<e.length;r++){let l=e[r].Notes;for(var n=0;n<l.length;n++){let e=l[n];null!=e&&t.push({note:e.halfTone+12,time:4*o.currentTimeStamp.RealValue,length:e.Length.RealValue})}}o.moveToNext()}let l=[],c={};t.forEach((e,t)=>{c.hasOwnProperty(e.time)||(l.push(e),c[e.time]=l.length-1)}),I.current=l,S.current=c,y.current=e.cursor}},et=async()=>{try{let e=await fetch("".concat(u.Ic,"/midi-devices")),t=await e.json();A(t.devices),t.devices.length>0&&_(t.devices[0].id)}catch(e){console.error("Error fetching MIDI devices:",e)}},er=async()=>{if(y.current&&j.current){if(V){var e;null==(e=C.current)||e.play()}k(!0),H(!0),console.log("Starting music playback..."),y.current.reset(),N.current=new WebSocket("".concat(u.Ic.replace(/^http/,"ws"),"/ws")),N.current.onopen=()=>{var e;console.log("WebSocket connection opened"),null==(e=N.current)||e.send(JSON.stringify({file_id:j.current,input_type:E.toLowerCase(),isPerformceModel:F,device:F?"":E===p?c:P}))},N.current.onmessage=e=>{let t=JSON.parse(e.data);console.log("WebSocket message received:",t),void 0!==t.beat_position&&Q(t.beat_position)},N.current.onclose=()=>{console.log("WebSocket connection closed"),k(!1)},N.current.onerror=e=>{console.error("WebSocket error:",e),k(!1)}}},en=()=>{console.log("Stopping music"),C.current&&(C.current.pause(),C.current.seekTo(0)),B(0),N.current&&(N.current.send(JSON.stringify({action:"stop"})),N.current.close(),N.current=null),k(!1),console.log("WebSocket connection closed")},eo=async e=>{try{let t=await fetch("".concat(u.WW,"/cloud/get-audio-file-by-id/").concat(e));if(t.ok){let e=await t.blob();X(e)}}catch(e){console.error("Error fetching demo audio:",e)}};return(0,o.useEffect)(()=>{"demo"===z?(q(!0),j.current&&eo(j.current)):(q(!1),X(null))},[z]),(0,n.jsxs)("div",{className:"min-h-screen flex flex-col",children:[(0,n.jsxs)("header",{className:"flex justify-between items-center p-4 bg-gray-800 text-white",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,n.jsx)("h1",{className:"text-xl font-bold",children:"Practice"}),(0,n.jsxs)(g.W1,{as:"div",className:"relative",children:[(0,n.jsxs)(g.W1.Button,{className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors",children:["follow"===z&&"跟音练习","demo"===z&&"演示模式","evaluate"===z&&"测评模式"]}),(0,n.jsxs)(g.W1.Items,{className:"absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10",children:[(0,n.jsx)(g.W1.Item,{children:e=>{let{active:t}=e;return(0,n.jsx)("button",{className:"".concat(t?"bg-blue-500 text-white":"text-gray-900"," group flex w-full items-center px-4 py-2 text-sm"),onClick:()=>J("follow"),children:"跟音练习"})}}),(0,n.jsx)(g.W1.Item,{children:e=>{let{active:t}=e;return(0,n.jsx)("button",{className:"".concat(t?"bg-blue-500 text-white":"text-gray-900"," group flex w-full items-center px-4 py-2 text-sm"),onClick:()=>J("demo"),children:"演示模式"})}}),(0,n.jsx)(g.W1.Item,{children:e=>{let{active:t}=e;return(0,n.jsx)("button",{className:"".concat(t?"bg-blue-500 text-white":"text-gray-900"," group flex w-full items-center px-4 py-2 text-sm"),onClick:()=>J("evaluate"),children:"测评模式"})}})]})]})]}),(0,n.jsx)("button",{onClick:()=>e.back(),className:"bg-red-500 text-white px-4 py-2 rounded",children:"返回"})]}),(0,n.jsxs)("div",{className:"flex-1 pb-32",children:[(0,n.jsxs)("div",{className:"flex flex-col items-center space-y-3 py-2",children:[("follow"===z||"evaluate"===z)&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"flex space-x-4 items-center",children:[(0,n.jsx)("button",{onClick:()=>T(p),className:"px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(E===p?"bg-blue-500 text-white shadow-md scale-105":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:"\uD83C\uDFA4 Audio"}),(0,n.jsx)("button",{onClick:()=>T(x),className:"px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(E===x?"bg-blue-500 text-white shadow-md scale-105":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:"\uD83C\uDFB9 MIDI"})]}),(0,n.jsxs)("div",{children:[E===p&&(0,n.jsxs)("div",{className:"flex space-x-4 items-center",children:[(0,n.jsx)("div",{className:"w-64",children:(0,n.jsx)(m.A,{audioDevices:r,selectedAudioDevice:c,setSelectedAudioDevice:b})}),(0,n.jsx)("div",{children:E===p&&(0,n.jsx)(i,{deviceIndex:c})})]}),E===x&&(0,n.jsx)("div",{className:"w-64 mt-4",children:(0,n.jsx)("select",{value:P,onChange:e=>_(e.target.value),className:"w-full px-4 py-2 rounded-md bg-white border border-gray-200 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all duration-200",children:D.map((e,t)=>(0,n.jsx)("option",{value:e.id,children:e.name||"MIDI Device ".concat(t+1)},t))})})]})]}),(0,n.jsxs)("div",{className:"flex space-x-4 mt-4",children:[(0,n.jsxs)("button",{onClick:er,disabled:R,className:"flex items-center px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(R?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-green-500 text-white hover:bg-green-600 shadow-md"),children:[(0,n.jsx)("span",{className:"mr-2",children:"▶️"})," Play"]}),(0,n.jsxs)("button",{onClick:()=>{C.current&&(B(C.current.getCurrentTime()),C.current.pause()),k(!1),console.log("Music paused")},disabled:!R,className:"flex items-center px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(R?"bg-yellow-500 text-white hover:bg-yellow-600 shadow-md":"bg-gray-200 text-gray-400 cursor-not-allowed"),children:[(0,n.jsx)("span",{className:"mr-2",children:"⏸️"})," Pause"]}),(0,n.jsxs)("button",{onClick:en,disabled:!R,className:"flex items-center px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(R?"bg-red-500 text-white hover:bg-red-600 shadow-md":"bg-gray-200 text-gray-400 cursor-not-allowed"),children:[(0,n.jsx)("span",{className:"mr-2",children:"⏹️"})," Stop"]}),"evaluate"===z&&(0,n.jsx)("button",{className:"px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(!R&&G?"bg-blue-500 text-white hover:bg-blue-600 shadow-md":"bg-gray-200 text-gray-400 cursor-not-allowed"),disabled:R||!G,onClick:()=>{},children:R?"录音中":"提交测评"})]})]}),(0,n.jsx)("div",{ref:w,id:"osmdContainer"}),"demo"===z&&(0,n.jsx)(a,{ref:C,isPerformceModel:F,audioUrl:K,isPlaying:R,onPlay:()=>{R||er()},onPause:()=>{R&&en()},onEnded:en})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[701,128,918,389,884,636,593,792],()=>t(4340)),_N_E=e.O()}]);