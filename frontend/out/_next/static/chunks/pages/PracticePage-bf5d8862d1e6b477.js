(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6],{3186:(e,t,r)=>{"use strict";r.d(t,{x:()=>a});var n=r(4232),o=r(4590),l=r(900);let c=async()=>{try{console.log("Fetching audio devices..."),console.log("Platform:",l.Ii.getPlatform()),console.log("Backend URL:",o.Ic);try{let e=await fetch("".concat(o.Ic,"/audio-devices"));if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));let t=await e.json();if(console.log("Backend response:",t),!t.devices||0===t.devices.length)return{devices:[],error:"未检测到音频设备。请确保已连接麦克风或其他音频输入设备。"};return{devices:t.devices}}catch(e){return console.error("Web API error:",e),{devices:[],error:"无法连接到音频设备服务。请检查网络连接或重试。"}}}catch(e){return console.error("Error fetching audio devices:",e),e instanceof Error&&(console.error("Error details:",e.message),console.error("Error stack:",e.stack)),{devices:[],error:"获取音频设备时发生错误。请重试或联系支持。"}}},a=()=>{let[e,t]=(0,n.useState)([]),[r,o]=(0,n.useState)(0),[l,a]=(0,n.useState)(),[s,i]=(0,n.useState)(!0);(0,n.useEffect)(()=>{(async()=>{try{i(!0),a(void 0);let e=await c();e.error?(a(e.error),t([])):(t(e.devices),e.devices.length>0&&o(e.devices[0].index))}catch(e){a("加载音频设备时发生错误"),t([])}finally{i(!1)}})()},[]);let u=async()=>{let e=await c();e.error?(a(e.error),t([])):(t(e.devices),e.devices.length>0&&o(e.devices[0].index))};return{audioDevices:e,selectedAudioDevice:r,setSelectedAudioDevice:o,error:l,isLoading:s,refreshDevices:u}}},4287:(e,t,r)=>{"use strict";r.d(t,{X:()=>n});let n=(0,r(5664).eU)({key:"practiceState",default:null})},4340:(e,t,r)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/PracticePage",function(){return r(8990)}])},4590:(e,t,r)=>{"use strict";r.d(t,{Ic:()=>i,WW:()=>s,pt:()=>a,w8:()=>c,y4:()=>o}),r(900);var n=r(5364);let o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";try{let r=atob(e),n=r.length,o=new Uint8Array(n);for(let e=0;e<n;e++)o[e]=r.charCodeAt(e);return new Blob([o],{type:t})}catch(e){return console.error("Failed to decode Base64 data:",e),null}},l=()=>(n.env.NEXT_CLOUD_BACKEND_URL,"http://192.168.68.58:8101/cloud"),c=(e,t)=>"score"===t?"".concat(l(),"/get-score-file-by-id/").concat(e):"audio"===t?"".concat(l(),"/get-audio-file-by-id/").concat(e):"midi"===t?"".concat(l(),"/get-midi-file-by-id/").concat(e):"";var a=function(e){return e.SCORE="score",e.AUDIO="audio",e.MIDI="midi",e}({});let s=l(),i=(n.env.NEXT_LOCAL_BACKEND_URL||"http://localhost:8201")+"/local"},5895:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var n=r(7876);r(4232);let o=e=>{let{audioDevices:t,selectedAudioDevice:r,setSelectedAudioDevice:o,error:l,isLoading:c,onRefresh:a}=e;return c?(0,n.jsx)("div",{className:"w-full text-center py-2 text-gray-600",children:"正在加载音频设备..."}):l?(0,n.jsxs)("div",{className:"w-full",children:[(0,n.jsx)("div",{className:"text-red-500 mb-2",children:l}),a&&(0,n.jsx)("button",{onClick:a,className:"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors",children:"重试"})]}):0===t.length?(0,n.jsx)("div",{className:"w-full text-center py-2 text-gray-600",children:"未检测到音频设备"}):(0,n.jsx)("div",{children:(0,n.jsx)("select",{value:r,onChange:e=>o(Number(e.target.value)),className:"w-full px-4 py-2 rounded-md bg-white border border-gray-200 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all duration-200",children:t.map((e,t)=>(0,n.jsx)("option",{value:e.index,children:e.name||"音频设备 ".concat(t+1)},t))})})}},8990:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>v});var n=r(7876),o=r(4232),l=r(9099),c=r(885);r(379);let a=(0,o.forwardRef)((e,t)=>{let{isPerformceModel:r,audioUrl:l,isPlaying:a,onPlay:s,onPause:i,onEnded:u}=e,d=o.useRef(null);return(0,o.useImperativeHandle)(t,()=>({play:()=>{var e;null==(e=d.current)||e.audio.current.play()},pause:()=>{var e;null==(e=d.current)||e.audio.current.pause()},seekTo:e=>{var t;(null==(t=d.current)?void 0:t.audio.current)&&(d.current.audio.current.currentTime=e)},getCurrentTime:()=>{var e,t;return(null==(t=d.current)||null==(e=t.audio.current)?void 0:e.currentTime)||0}})),o.useEffect(()=>()=>{l&&URL.revokeObjectURL(l)},[r,l]),(0,n.jsx)("div",{children:(0,n.jsx)(c.A,{ref:d,src:l,showSkipControls:!1,showJumpControls:!1,showDownloadProgress:!1,autoPlay:a,onPlay:s,onPause:i,onEnded:u})})}),s=e=>{let{deviceIndex:t}=e,r=(0,o.useRef)(null),l=(0,o.useRef)(),c=(0,o.useRef)(null),a=(0,o.useRef)(null),s=(0,o.useRef)(null);(0,o.useEffect)(()=>{(async()=>{try{let e=new(window.AudioContext||window.webkitAudioContext);c.current=e;let r=await navigator.mediaDevices.getUserMedia({audio:{deviceId:t.toString(),echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),n=e.createAnalyser();n.fftSize=256,a.current=n;let o=e.createMediaStreamSource(r);return s.current=o,o.connect(n),i(),()=>{s.current&&s.current.disconnect(),c.current&&c.current.close(),l.current&&cancelAnimationFrame(l.current)}}catch(e){console.error("Error setting up audio:",e)}})()},[t]);let i=()=>{let e,t=r.current,n=a.current;if(!t||!n)return;let o=t.getContext("2d");if(!o)return;let c=n.frequencyBinCount,s=new Uint8Array(c);n.getByteFrequencyData(s),o.fillStyle="rgb(240, 240, 240)",o.fillRect(0,0,t.width,t.height);let u=t.width/c*2,d=0;for(let r=0;r<c;r++){e=s[r]/255*t.height;let n=o.createLinearGradient(0,0,0,t.height);n.addColorStop(0,"#4ade80"),n.addColorStop(.5,"#fbbf24"),n.addColorStop(1,"#ef4444"),o.fillStyle=n,o.beginPath(),o.moveTo(d+2,t.height),o.lineTo(d+u-2,t.height),o.quadraticCurveTo(d+u,t.height,d+u,t.height-2),o.lineTo(d+u,t.height-e+2),o.quadraticCurveTo(d+u,t.height-e,d+u-2,t.height-e),o.lineTo(d+2,t.height-e),o.quadraticCurveTo(d,t.height-e,d,t.height-e+2),o.lineTo(d,t.height-2),o.quadraticCurveTo(d,t.height,d+2,t.height),o.closePath(),o.fill(),d+=u+1}l.current=requestAnimationFrame(i)};return(0,n.jsx)("div",{className:"flex items-center space-x-4",children:(0,n.jsx)("div",{className:"h-10 w-48 bg-white border border-gray-200 rounded-md shadow-sm overflow-hidden",children:(0,n.jsx)("canvas",{ref:r,width:192,height:40,className:"w-full h-full"})})})};var i=r(5602),u=r(4590),d=r(5664),h=r(4287),f=r(3186),g=r(9190),m=r(5895);let x="MIDI",p="Audio",v=()=>{let e=(0,l.useRouter)(),t=(0,d.vc)(h.X),{audioDevices:r,selectedAudioDevice:c,setSelectedAudioDevice:v,error:b,isLoading:w,refreshDevices:y}=(0,f.x)(),j=(0,o.useRef)(null),C=(0,o.useRef)(null),N=(0,o.useRef)(null),S=(0,o.useRef)(null),k=(0,o.useRef)(null),I=(0,o.useRef)({}),R=(0,o.useRef)(null),E=(0,o.useRef)([]),[T,P]=(0,o.useState)(!1),[D,A]=(0,o.useState)(x),[_,U]=(0,o.useState)([]),[O,W]=(0,o.useState)(""),[L,M]=(0,o.useState)(0),[B,F]=(0,o.useState)(0),[q,V]=(0,o.useState)(0),[X,z]=(0,o.useState)(!1),[J,H]=(0,o.useState)(null),[G,K]=(0,o.useState)("follow"),[Q,Y]=(0,o.useState)(!1),Z=(0,o.useMemo)(()=>{if(t){if("true"===t.useUrl)return t.audioUrl;if(t.audioContent){let e="string"==typeof t.audioContent?(0,u.y4)(t.audioContent):null;return e?URL.createObjectURL(e):void 0}}},[X]);(0,o.useEffect)(()=>{console.log("Real-time position: ".concat(B,", Anchor position index: ").concat(L)),B!==L&&($(B),console.log("realTimePosition: ",B),M(B),console.log("Best position updated to:",L))},[B]),(0,o.useEffect)(()=>{j.current&&t&&(k.current=t.fileInfo.id,C.current=new i.OpenSheetMusicDisplay(j.current),console.log("OSMD initialized"),(async()=>{try{if("false"===t.useUrl&&t.fileContent){let e=(0,u.y4)(t.fileContent);if(null===e)return;let r=await e.text();await C.current.load(r),await C.current.render(),N.current=C.current.cursor,console.log("Cursor initialized:",N.current),en(C.current),N.current&&(N.current.reset(),N.current.show(),console.log("Cursor position after reset:",N.current.Iterator.currentTimeStamp.RealValue))}else if("true"===t.useUrl&&t.fileUrl){let e=await fetch((0,u.w8)(t.fileInfo.id,u.pt.SCORE));if(!e.ok)throw Error("HTTP error! status: ".concat(e.status));let r=await e.text();await C.current.load(r),await C.current.render(),N.current=C.current.cursor,console.log("Cursor initialized:",N.current),en(C.current),N.current&&(N.current.reset(),N.current.show(),console.log("Cursor position after reset:",N.current.Iterator.currentTimeStamp.RealValue))}}catch(e){console.error("Error loading file:",e)}})())},[t]),(0,o.useEffect)(()=>{D===p?r.length>0&&v(r[0].index):D===x&&eo()},[D]);let $=e=>{if(et("Moving to target beat: ".concat(e)),C.current&&(N.current=C.current.cursor,N.current)){let t=ee(),r=I.current[t],n=I.current[e];if(void 0===r)return void et("Invalid current beat position. Cursor's current beat: ".concat(t));if(void 0===n){let t=Object.keys(I.current).map(Number).sort((e,t)=>e-t),r=er(t,e);n=I.current[t[r]],et("Closest target index found: ".concat(n))}let o=n-r;if(et("Steps to move: ".concat(o)),o>0)for(let e=0;e<o;e++)N.current.next();else if(o<0)for(let e=0;e<Math.abs(o);e++)N.current.previous();C.current.cursor.update(),N.current.show()}},ee=()=>N.current&&N.current.Iterator?4*N.current.Iterator.currentTimeStamp.RealValue:0,et=e=>{let t=new Date().toISOString();console.log("[".concat(t,"] ").concat(e))},er=(e,t)=>{let r=e.findLastIndex(e=>e<=t);return -1===r&&(r=0),r},en=e=>{if(e&&e.cursor){let o=e.cursor.Iterator;for(var t=[];!o.EndReached;){let e=o.CurrentVoiceEntries;for(var r=0;r<e.length;r++){let l=e[r].Notes;for(var n=0;n<l.length;n++){let e=l[n];null!=e&&t.push({note:e.halfTone+12,time:4*o.currentTimeStamp.RealValue,length:e.Length.RealValue})}}o.moveToNext()}let l=[],c={};t.forEach((e,t)=>{c.hasOwnProperty(e.time)||(l.push(e),c[e.time]=l.length-1)}),E.current=l,I.current=c,N.current=e.cursor}},eo=async()=>{try{let e=await fetch("".concat(u.Ic,"/midi-devices")),t=await e.json();U(t.devices),t.devices.length>0&&W(t.devices[0].id)}catch(e){console.error("Error fetching MIDI devices:",e)}},el=async()=>{if(N.current&&k.current){if(J){var e;null==(e=S.current)||e.play()}P(!0),Y(!0),console.log("Starting music playback..."),N.current.reset(),R.current=new WebSocket("".concat(u.Ic.replace(/^http/,"ws"),"/ws")),R.current.onopen=()=>{var e;console.log("WebSocket connection opened"),null==(e=R.current)||e.send(JSON.stringify({file_id:k.current,input_type:D.toLowerCase(),isPerformceModel:X,device:X?"":D===p?c:O}))},R.current.onmessage=e=>{let t=JSON.parse(e.data);console.log("WebSocket message received:",t),void 0!==t.beat_position&&$(t.beat_position)},R.current.onclose=()=>{console.log("WebSocket connection closed"),P(!1)},R.current.onerror=e=>{console.error("WebSocket error:",e),P(!1)}}},ec=()=>{console.log("Stopping music"),S.current&&(S.current.pause(),S.current.seekTo(0)),V(0),R.current&&(R.current.send(JSON.stringify({action:"stop"})),R.current.close(),R.current=null),P(!1),console.log("WebSocket connection closed")},ea=async e=>{try{let t=await fetch("".concat(u.WW,"/cloud/get-audio-file-by-id/").concat(e));if(t.ok){let e=await t.blob();H(e)}}catch(e){console.error("Error fetching demo audio:",e)}};return(0,o.useEffect)(()=>{"demo"===G?(z(!0),k.current&&ea(k.current)):(z(!1),H(null))},[G]),(0,n.jsxs)("div",{className:"min-h-screen flex flex-col",children:[(0,n.jsxs)("header",{className:"flex justify-between items-center p-4 bg-gray-800 text-white",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,n.jsx)("h1",{className:"text-xl font-bold",children:"Practice"}),(0,n.jsxs)(g.W1,{as:"div",className:"relative",children:[(0,n.jsxs)(g.W1.Button,{className:"bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors",children:["follow"===G&&"跟音练习","demo"===G&&"演示模式","evaluate"===G&&"测评模式"]}),(0,n.jsxs)(g.W1.Items,{className:"absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10",children:[(0,n.jsx)(g.W1.Item,{children:e=>{let{active:t}=e;return(0,n.jsx)("button",{className:"".concat(t?"bg-blue-500 text-white":"text-gray-900"," group flex w-full items-center px-4 py-2 text-sm"),onClick:()=>K("follow"),children:"跟音练习"})}}),(0,n.jsx)(g.W1.Item,{children:e=>{let{active:t}=e;return(0,n.jsx)("button",{className:"".concat(t?"bg-blue-500 text-white":"text-gray-900"," group flex w-full items-center px-4 py-2 text-sm"),onClick:()=>K("demo"),children:"演示模式"})}}),(0,n.jsx)(g.W1.Item,{children:e=>{let{active:t}=e;return(0,n.jsx)("button",{className:"".concat(t?"bg-blue-500 text-white":"text-gray-900"," group flex w-full items-center px-4 py-2 text-sm"),onClick:()=>K("evaluate"),children:"测评模式"})}})]})]})]}),(0,n.jsx)("button",{onClick:()=>e.back(),className:"bg-red-500 text-white px-4 py-2 rounded",children:"返回"})]}),(0,n.jsxs)("div",{className:"flex-1 pb-32",children:[(0,n.jsxs)("div",{className:"flex flex-col items-center space-y-3 py-2",children:[("follow"===G||"evaluate"===G)&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"flex space-x-4 items-center",children:[(0,n.jsx)("button",{onClick:()=>A(p),className:"px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(D===p?"bg-blue-500 text-white shadow-md scale-105":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:"\uD83C\uDFA4 Audio"}),(0,n.jsx)("button",{onClick:()=>A(x),className:"px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(D===x?"bg-blue-500 text-white shadow-md scale-105":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:"\uD83C\uDFB9 MIDI"})]}),(0,n.jsxs)("div",{children:[D===p&&(0,n.jsxs)("div",{className:"flex space-x-4 items-center",children:[(0,n.jsx)("div",{className:"w-64",children:(0,n.jsx)(m.A,{audioDevices:r,selectedAudioDevice:c,setSelectedAudioDevice:v,error:b,isLoading:w,onRefresh:y})}),(0,n.jsx)("div",{children:D===p&&!b&&!w&&(0,n.jsx)(s,{deviceIndex:c})})]}),D===x&&(0,n.jsx)("div",{className:"w-64 mt-4",children:(0,n.jsx)("select",{value:O,onChange:e=>W(e.target.value),className:"w-full px-4 py-2 rounded-md bg-white border border-gray-200 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all duration-200",children:_.map((e,t)=>(0,n.jsx)("option",{value:e.id,children:e.name||"MIDI Device ".concat(t+1)},t))})})]})]}),(0,n.jsxs)("div",{className:"flex space-x-4 mt-4",children:[(0,n.jsxs)("button",{onClick:el,disabled:T,className:"flex items-center px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(T?"bg-gray-200 text-gray-400 cursor-not-allowed":"bg-green-500 text-white hover:bg-green-600 shadow-md"),children:[(0,n.jsx)("span",{className:"mr-2",children:"▶️"})," Play"]}),(0,n.jsxs)("button",{onClick:()=>{S.current&&(V(S.current.getCurrentTime()),S.current.pause()),P(!1),console.log("Music paused")},disabled:!T,className:"flex items-center px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(T?"bg-yellow-500 text-white hover:bg-yellow-600 shadow-md":"bg-gray-200 text-gray-400 cursor-not-allowed"),children:[(0,n.jsx)("span",{className:"mr-2",children:"⏸️"})," Pause"]}),(0,n.jsxs)("button",{onClick:ec,disabled:!T,className:"flex items-center px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(T?"bg-red-500 text-white hover:bg-red-600 shadow-md":"bg-gray-200 text-gray-400 cursor-not-allowed"),children:[(0,n.jsx)("span",{className:"mr-2",children:"⏹️"})," Stop"]}),"evaluate"===G&&(0,n.jsx)("button",{className:"px-6 py-2 rounded-full font-medium transition-all duration-200 ".concat(!T&&Q?"bg-blue-500 text-white hover:bg-blue-600 shadow-md":"bg-gray-200 text-gray-400 cursor-not-allowed"),disabled:T||!Q,onClick:()=>{},children:T?"录音中":"提交测评"})]})]}),(0,n.jsx)("div",{ref:j,id:"osmdContainer"}),"demo"===G&&(0,n.jsx)(a,{ref:S,isPerformceModel:X,audioUrl:Z,isPlaying:T,onPlay:()=>{T||el()},onPause:()=>{T&&ec()},onEnded:ec})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[701,128,918,389,884,636,593,792],()=>t(4340)),_N_E=e.O()}]);